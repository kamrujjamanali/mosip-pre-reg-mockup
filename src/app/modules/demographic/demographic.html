<!-- src/app/demographic-upload/demographic-upload.component.html -->
<div class="page" [attr.data-theme]="theme">
  <!-- <div class="themeFloating">
    <select [ngModel]="theme" (ngModelChange)="changeTheme($event)">
      <option *ngFor="let t of themes" [value]="t.name">{{ t.label }}</option>
    </select>
  </div> -->

  <ng-container [ngSwitch]="theme">

    <!-- ===========================================================
         DEFAULT (MOSIP) – DO NOT REMOVE ANYTHING
         =========================================================== -->
    <ng-container *ngSwitchCase="'default'">

      <!-- Top MOSIP stepper strip -->
      <div *ngIf="!isUploadPreview" class="dStepper">
        <div class="dStep active">
          <mat-icon class="dIcon">description</mat-icon>
          <span class="dStepText activeText">Demographics Details</span>
          <div class="dLine pinkLine"></div>
        </div>

        <div class="dStep">
          <mat-icon class="dIcon">upload</mat-icon>
          <span class="dStepText">Upload Document</span>
          <div class="dLine"></div>
        </div>

        <div class="dStep disabled">
          <mat-icon class="dIcon">event</mat-icon>
          <span class="dStepText">Book Appointment</span>
          <div class="dLine"></div>
        </div>

        <div class="dStep disabled">
          <mat-icon class="dIcon">description</mat-icon>
          <span class="dStepText">Confirmation</span>
        </div>
      </div>

      <div class="dContainer">

        <div *ngIf="!isUploadPreview" class="dHeaderRow">
          <div class="dTitle">
            {{ activeStepIndex === 0 ? 'Demographic Details' : activeStepIndex === 0 ? 'Book Appointment' : 'Upload Documents' }}
                @if(activeStepIndex<2) {
                  <span class="muted"> ( {{ dataCaptureLanguage }} )</span>
                }
                @if(activeStepIndex == 2 && selectSlots) {
                  <div class="dBookNote">
                    Please note that the application details cannot be modified once appointment is booked for it.
                  </div>
                }
          </div>

          <button *ngIf="activeStepIndex === 0" type="button" class="dBtnPink" (click)="changeDataCaptureLanguages()">
            CHANGE DATA CAPTURE LANGUAGES
          </button>
        </div>

        <div *ngIf="!isUploadPreview" class="dPinkDivider"></div>

        <!-- ===================== DEMOGRAPHIC (12 fields) ===================== -->
        <ng-container *ngIf="activeStepIndex === 0">
          <div class="dGrid4">

            <!-- Full Name -->
            <div class="dCard">
              <div class="dCardHead">Full Name : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <input matInput placeholder="Full Name" [(ngModel)]="fullName" />
                  <button mat-icon-button matSuffix type="button"><mat-icon>keyboard</mat-icon></button>
                </mat-form-field>
              </div>
            </div>

            <!-- DOB -->
            <div class="dCard">
              <div class="dCardHead">Date Of Birth : <span class="req">*</span></div>
              <div class="dCardBody dDobRow">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <input matInput [matDatepicker]="dobPicker" placeholder="DD/MM/YYYY" [(ngModel)]="dob" />
                  <button mat-icon-button matSuffix type="button" (click)="dobPicker.open()">
                    <mat-icon>calendar_month</mat-icon>
                  </button>

                  <mat-datepicker #dobPicker></mat-datepicker>
                </mat-form-field>

                <div class="dOr">OR</div>

                <mat-form-field class="w100 lineField" appearance="fill">
                  <input matInput placeholder="Age" [(ngModel)]="age" />
                </mat-form-field>
                <label for="" style="margin-top: 15px;">Years</label>
                <!-- <mat-form-field class="w100 lineField" appearance="fill">
                  <input matInput placeholder="Years" [(ngModel)]="years" />
                </mat-form-field> -->
              </div>
            </div>

            <!-- Gender -->
            <div class="dCard">
              <div class="dCardHead">Gender : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <mat-select [(ngModel)]="gender" placeholder="Gender">
                    <mat-option *ngFor="let g of genders" [value]="g.code">{{ g.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- Residence -->
            <div class="dCard">
              <div class="dCardHead">Residence Status : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <mat-select [(ngModel)]="residenceStatus" placeholder="Residence Status">
                    <mat-option *ngFor="let r of residenceStatuses" [value]="r.code">{{ r.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- Address -->
            <div class="dCard">
              <div class="dCardHead">Address : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <input matInput placeholder="Address" [(ngModel)]="address" />
                  <button mat-icon-button matSuffix type="button"><mat-icon>keyboard</mat-icon></button>
                </mat-form-field>
              </div>
            </div>

            <!-- Region -->
            <div class="dCard">
              <div class="dCardHead">Region : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <mat-select [(ngModel)]="region" placeholder="Region">
                    <mat-option *ngFor="let r of regions" [value]="r.code">{{ r.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- Province -->
            <div class="dCard">
              <div class="dCardHead">Province : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <mat-select [(ngModel)]="parish" placeholder="Province" (selectionChange)="onParishChange()">
                    <mat-option *ngFor="let p of parishes" [value]="p.code">{{ p.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- City -->
            <div class="dCard">
              <div class="dCardHead">City : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <mat-select [(ngModel)]="city" placeholder="City" [disabled]="!parish">
                    <mat-option *ngFor="let c of cities" [value]="c.code">{{ c.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- Zone -->
            <div class="dCard">
              <div class="dCardHead">Zone : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <mat-select [(ngModel)]="zone" placeholder="Zone">
                    <mat-option *ngFor="let z of zones" [value]="z.code">{{ z.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- Postal Code -->
            <div class="dCard">
              <div class="dCardHead">Postal Code : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <mat-select [(ngModel)]="postalCode" placeholder="Postal Code">
                    <mat-option *ngFor="let p of postalCodes" [value]="p.code">{{ p.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- Phone -->
            <div class="dCard">
              <div class="dCardHead">Phone : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <input matInput placeholder="Phone" [(ngModel)]="phone" />
                </mat-form-field>
              </div>
            </div>

            <!-- Email -->
            <div class="dCard">
              <div class="dCardHead">Email : <span class="req">*</span></div>
              <div class="dCardBody">
                <mat-form-field class="w100 lineField" appearance="fill">
                  <input matInput placeholder="Email" [(ngModel)]="email" />
                </mat-form-field>
              </div>
            </div>

          </div>

          <div class="dBottomFixed">
            <button class="dBtnPink" type="button" (click)="goToUpload()">CONTINUE</button>
          </div>
        </ng-container>

        <!-- ===================== UPLOAD (eye icon -> right preview) ===================== -->
        <!-- ===================== UPLOAD (DEFAULT) ===================== -->
        <ng-container *ngIf="activeStepIndex === 1">

          <!-- ✅ NORMAL UPLOAD SCREEN -->
          <ng-container *ngIf="!isUploadPreview">
            <div class="dUploadNote">
              Allowed file type : {{ allowedTypes }} and allowed file size : {{ maxSizeText }}
            </div>

            <div class="dUploadLayout">
              <div class="dUploadLeft">
                <div class="dUploadCard" *ngFor="let d of documents">
                  <div class="dCardHead">
                    {{ d.title }} <span *ngIf="d.required">: <span class="req">*</span></span>
                  </div>

                  <div class="dUploadBody">
                    <div class="dUploadRow">
                      <mat-form-field class="w100 lineField" appearance="fill">
                        <mat-select [(ngModel)]="d.docType" placeholder="{{ d.title }}">
                          <mat-option *ngFor="let opt of getDocTypeOptions(d.key)" [value]="opt.code">
                            {{ opt.label }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field class="w100 lineField" appearance="fill">
                        <input matInput placeholder="Document Reference Id" [(ngModel)]="d.refId" />
                      </mat-form-field>

                      <input #fileInput type="file" class="hiddenFile" accept=".pdf,.png,.jpg,.jpeg"
                        (change)="onFileSelected(d, $event)" />

                      <button type="button" class="dBrowse" (click)="browseFile(d, fileInput)">BROWSE</button>
                    </div>

                    <div class="dFileRow" *ngIf="d.fileName">
                      <span class="dFileName">{{ d.fileName }}</span>
                      <div class="dFileIcons">
                        <button mat-icon-button type="button" (click)="preview(d)" title="Preview">
                          <mat-icon>visibility</mat-icon>
                        </button>
                        <button mat-icon-button type="button" (click)="remove(d)" title="Remove">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

              </div>

              <div class="dUploadRight">
                <div class="dPreviewShell">
                  <div class="dPreviewTitle" *ngIf="selectedPreviewTitle">{{ selectedPreviewTitle }}</div>

                  <div class="dPreviewEmpty" *ngIf="previewKind === 'none'">
                    Click the eye icon to preview PDF/Image here.
                  </div>

                  <iframe *ngIf="previewKind === 'pdf' && safePdfUrl" class="previewFrame" [src]="safePdfUrl">
                  </iframe>

                  <div *ngIf="previewKind === 'image' && safeImgUrl" class="imgWrap">
                    <img [src]="safeImgUrl" alt="preview" />
                  </div>
                </div>
              </div>
            </div>

            <div class="dBottomBar2">
              <button class="dBtnOutline" type="button" (click)="goToDemographic()">BACK</button>

              <!-- ✅ IMPORTANT: Continue now opens Preview (same step) -->
              <button class="dBtnPink" type="button" (click)="openUploadPreview()">CONTINUE</button>
            </div>
          </ng-container>


          <!-- ✅ PREVIEW SCREEN INSIDE UPLOAD STEP (DEFAULT) -->
          <ng-container *ngIf="isUploadPreview">

            <div class="dPreviewHeaderRow">
              <div class="dPreviewTitleTop">Preview ( {{ dataCaptureLanguage }} )</div>

              <button type="button" class="dPreviewModify" (click)="goToDemographic()">
                <mat-icon>edit</mat-icon> modify
              </button>
            </div>

            <div class="dPinkDivider"></div>

            <div class="dPreviewGrid">
              <div class="dPreviewRow">
                <div class="k">Full Name :</div>
                <div class="v">{{ fullName }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">Date Of Birth :</div>
                <div class="v">{{ dobPreviewText }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">Gender :</div>
                <div class="v">{{ genderLabel }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">Residence Status :</div>
                <div class="v">{{ residenceLabel }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">Address :</div>
                <div class="v">{{ address }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">Region :</div>
                <div class="v">{{ regionLabel }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">Province :</div>
                <div class="v">{{ parishLabel }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">City :</div>
                <div class="v">{{ cityLabel }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">Zone :</div>
                <div class="v">{{ zoneLabel }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">Postal Code :</div>
                <div class="v">{{ postalLabel }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">Phone :</div>
                <div class="v">{{ phone }}</div>
              </div>
              <div class="dPreviewRow">
                <div class="k">Email :</div>
                <div class="v">{{ email }}</div>
              </div>
            </div>

            <div class="dDocsHeaderRow">
              <div class="dDocsTitle">Documents Uploaded</div>

              <button type="button" class="dPreviewModify" (click)="backToUploadEdit()">
                <mat-icon>edit</mat-icon> modify
              </button>
            </div>

            <div class="dDocsDivider"></div>

            <div class="dDocsGrid">
              <div class="dDocCol" *ngFor="let d of documents">
                <div class="dDocHead">{{ d.title }}</div>
                <div class="dDocFile">{{ d.fileName || '-' }}</div>
              </div>
            </div>

            <!-- ✅ bottom buttons like screenshot -->
            <div class="dBottomBarPreview">
              <button class="dBtnOutline" type="button" (click)="backToUploadEdit()">BACK</button>

              <div class="dRightBtns">
                <button class="dBtnOutline" type="button">ADD APPLICANT</button>
                <button class="dBtnPink" type="button" (click)="continueFromPreview()">CONTINUE</button>
              </div>
            </div>

          </ng-container>

        </ng-container>

        <!-- ===================== BOOK APPOINTMENT (DEFAULT) ===================== -->
<ng-container *ngIf="activeStepIndex === 2">
  <ng-container *ngIf="!selectSlots">
    <div class="dBookTabsRow">
      <div class="dBookTabsLeft">
        <button type="button"
                class="dBookTab"
                [class.active]="bookTab==='recommended'"
                (click)="bookTab='recommended'">
          Recommended Centres
        </button>
        <span class="dBookSub">( Found {{ centres.length }} centers. )</span>
  
        <button type="button"
                class="dBookTab"
                [class.active]="bookTab==='nearby'"
                (click)="bookTab='nearby'">
          Nearby
        </button>
      </div>
  
      <button type="button" class="dBookSearchBtn" title="Search">
        <mat-icon>search</mat-icon>
      </button>
    </div>
  
    <div class="dBookLayout">
      <!-- LEFT -->
      <div class="dBookLeft">
  
        <div class="dCentreCard"
             *ngFor="let c of centres"
             [class.selected]="c.id===selectedCentreId"
             (click)="selectedCentreId=c.id">
  
          <div class="dCentreRadio">
            <div class="dRadioOuter" [class.on]="c.id===selectedCentreId">
              <div class="dRadioInner" *ngIf="c.id===selectedCentreId"></div>
            </div>
          </div>
  
          <div class="dCentreInfo">
            <div class="dCentreLine1">
              <mat-icon class="pin">location_on</mat-icon>
              <div class="dCentreNameAddr">
                <div class="nm">{{ c.name }}</div>
                <div class="addr">{{ c.addressLine }}</div>
              </div>
            </div>
  
            <div class="dCentreLine2" *ngIf="c.contactName || c.contactPhone">
              <mat-icon class="ph">call</mat-icon>
              <div class="contact">
                {{ c.contactName }} , {{ c.contactPhone }}
              </div>
            </div>
          </div>
  
          <div class="dCentreTiming">
            <div>{{ c.timingText }}</div>
            <div>{{ c.lunchText }}</div>
            <div>{{ c.openDaysText }}</div>
          </div>
        </div>
  
      </div>
  
      <!-- RIGHT MAP -->
      <div class="dBookRight">
        <div class="dMapShell">
          <iframe *ngIf="mapEmbedUrl" class="dMapFrame" [src]="mapEmbedUrl"></iframe>
        </div>
      </div>
    </div>
  
    <!-- bottom bar like screenshot -->
    <div class="dBookBottomBar">
      <button class="dBtnOutline" type="button" (click)="bookBack()">BACK</button>
  
      <div class="dBookRightBtns">
        <button class="dBtnOutline" type="button" (click)="bookLater()">BOOK LATER</button>
        <button class="dBtnPink" type="button" (click)="bookContinue()">CONTINUE</button>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="selectSlots">
    <div class="dBookWrap">
      <!-- Date carousel -->
      <div class="dDayRow">
        <button type="button" class="dDayNav" (click)="prevDays()">
          <span class="dNavText">Previous</span>
        </button>
  
        <div class="dDayCards">
          <div class="dDayCard"
               *ngFor="let day of visibleDays; let i=index"
               [class.active]="i===selectedDayIndex"
               (click)="selectDay(i)">
            <div class="dDayDate">{{ fmtDay(day.date) }}</div>
            <div class="dDayWeek">{{ fmtWeekday(day.date) }}</div>
            <div class="dDayCount">{{ day.availableCount }}</div>
            <div class="dDaySub">Available Bookings</div>
          </div>
        </div>
  
        <button type="button" class="dDayNav right" (click)="nextDays()">
          <span class="dNavText">Next</span>
        </button>
      </div>
  
      <!-- Tabs + layout -->
      <div class="dSlotsLayout">
        <!-- left main -->
        <div class="dSlotsLeft">
          <div class="dSessionTabs">
            <button type="button" class="dSessionTab"
                    [class.active]="selectedSession==='morning'"
                    (click)="setSession('morning')">Morning</button>
            <button type="button" class="dSessionTab"
                    [class.active]="selectedSession==='afternoon'"
                    (click)="setSession('afternoon')">Afternoon</button>
          </div>
  
          <div class="dSlotGrid">
            <div class="dSlotCell"
                 *ngFor="let s of filteredSlots"
                 [class.selected]="s.id===selectedSlotId"
                 (click)="selectSlot(s)">
              <div class="dSlotTime">{{ s.start }} - {{ s.end }}</div>
              <div class="dSlotAvail">{{ s.available }} slots</div>
            </div>
          </div>
        </div>
  
        <!-- right applicants panel -->
        <div class="dApplicants">
          <div class="dApplicantsHead">Available Applicants</div>
  
          <div class="dApplicantsBody">
            <div class="dApplicantRow" *ngFor="let a of applicants">
              <div class="dApplicantName"
                   [class.selected]="a.id===selectedApplicantId"
                   (click)="selectApplicant(a)">
                {{ a.name }}
              </div>
              <button type="button" class="dApplicantPlus" (click)="toggleApplicant(a)">
                {{ a.expanded ? '−' : '+' }}
              </button>
            </div>
  
            <div class="dApplicantExpand" *ngFor="let a of applicants">
              <div *ngIf="a.expanded" class="dApplicantDetails">
                Applicant Details will appear here (mock).
              </div>
            </div>
          </div>
        </div>
      </div>
  
    </div>

    <div class="dBookBottomBar">
      <button class="dBtnOutline" type="button" (click)="backFromSlotSelection()">BACK</button>
  
      <div class="dBookRightBtns">
        <button class="dBtnOutline" type="button" (click)="bookLater()">BOOK LATER</button>
        <button class="dBtnPink" type="button" (click)="continueAfterSlotSelection()">CONTINUE</button>
      </div>
    </div>
  </ng-container>

</ng-container>

<!-- ===================== CONFIRMATION (DEFAULT) ===================== -->
<ng-container *ngIf="activeStepIndex === 3">

  <div class="dConfirmWrap">

    <!-- green success strip -->
    <div class="dConfirmSuccess">
      <mat-icon class="ok">check_circle</mat-icon>
      <div class="msg">
        <b>{{ applicationId }}</b> : The Application ID and Appointment details have been sent to the registered email id and phone number
      </div>
    </div>

    <!-- top info block -->
    <div class="dConfirmBlock">
      <div class="dConfirmGridTop">
        <div class="dKV">
          <div class="k">Application ID :</div>
          <div class="v">{{ applicationId }}</div>
        </div>

        <div class="dKV">
          <div class="k">Appointment Date &amp; Time :</div>
          <div class="v">{{ appointmentDateTimeText }}</div>
        </div>

        <div class="dKV">
          <div class="k">Center Contact Number :</div>
          <div class="v">{{ centerContactNumber }}</div>
        </div>

        <div class="qr-dummy-real"></div>
      </div>

      <div class="dConfirmPinkLine"></div>

      <!-- bottom info -->
      <div class="dConfirmGridBottom">
        <div class="dKV">
          <div class="k">Name :</div>
          <div class="v">{{ confirmName }}</div>
        </div>

        <div class="dKV">
          <div class="k">Center Name :</div>
          <div class="v">{{ confirmCenterName }}</div>
        </div>
      </div>

      <div class="dConfirmPinkLine"></div>

      <div class="dConfirmGuidelines">
        {{ guidelinesText }}
      </div>
    </div>

  </div>

  <!-- bottom bar buttons -->
  <div class="dConfirmBottomBar">
    <button class="dBtnOutline thin" type="button" (click)="sendEmailSms()">SEND EMAIL/SMS</button>

    <div class="dConfirmRightBtns">
      <button class="dBtnOutline thin" type="button" (click)="downloadPdf()">DOWNLOAD PDF</button>
      <button class="dBtnPink thin" type="button" (click)="printConfirmation()">PRINT</button>
    </div>
  </div>

</ng-container>


      </div>
    </ng-container>

    <!-- ===========================================================
         GOVT THEME (layout changed but keeps ALL demographic fields)
         =========================================================== -->
    <ng-container *ngSwitchCase="'svg_gov'">
      <div class="govBg">

        <div class="govShell">
          <div class="govCard">

            <div *ngIf="!isUploadPreview" class="govHeaderRow">
              <div class="govPageTitle">
                {{ activeStepIndex === 0 ? 'Demographic Details' : activeStepIndex === 0 ? 'Book Appointment' : 'Upload Documents' }}
                @if(activeStepIndex<2) {
                  <span class="muted"> ( {{ dataCaptureLanguage }} )</span>
                }
                @if(activeStepIndex == 2 && selectSlots) {
                  <div class="dBookNote">
                    Please note that the application details cannot be modified once appointment is booked for it.
                  </div>
                }
              </div>

              <button *ngIf="activeStepIndex === 0" type="button" class="govPrimaryBtn"
                (click)="changeDataCaptureLanguages()">
                Change Data Capture Languages
              </button>
            </div>

            <div *ngIf="!isUploadPreview" class="govDivider"></div>

            <div *ngIf="!isUploadPreview" class="govStepper">
              <button type="button" class="govStep" [class.active]="activeStepIndex === 0"
                (click)="goToDemographic()">Demographics</button>
              <div class="govStepLine"></div>
              <button type="button" class="govStep" [class.active]="activeStepIndex === 1"
                (click)="goToUpload()">Upload</button>
              <div class="govStepLine"></div>
              <button type="button" class="govStep" [class.active]="activeStepIndex === 2">Book Appointment</button>
              <div class="govStepLine"></div>
              <button type="button" class="govStep" [class.active]="activeStepIndex === 3">Confirmation</button>
            </div>

            <!-- GOVT DEMO (ALL fields) -->
            <ng-container *ngIf="activeStepIndex === 0">
              <div class="govDemographicLayout">
                <div>
                  <div class="govDocPanel">
                    <div class="govDocHead">Personal Information</div>
                    <div class="govDocBody govDemoGraphicBody">
                      <div class="govField">
                        <label>Full Name <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <input matInput placeholder="Full Name" [(ngModel)]="fullName" />
                        </mat-form-field>
                      </div>
                      <div class="govField">
                        <label>Date of Birth <span class="required">*</span></label>
                        <div class="govDobRow">
                          <!-- ✅ DOB with datepicker -->
                          <mat-form-field appearance="fill" class="w100 govMatField">
                            <input matInput [matDatepicker]="dobPickerGov" placeholder="DD/MM/YYYY" [(ngModel)]="dob" />
                            <button mat-icon-button matSuffix type="button" (click)="dobPickerGov.open()">
                              <mat-icon>calendar_month</mat-icon>
                            </button>
                            <mat-datepicker #dobPickerGov></mat-datepicker>
                          </mat-form-field>
                          <div class="govOr">OR</div>
                          <mat-form-field appearance="fill" class="w100 govMatField">
                            <input matInput placeholder="Age" [(ngModel)]="age" />
                          </mat-form-field>
                          <label>Years</label>
                        </div>
                      </div>

                      <div class="govField">
                        <label>Gender <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <mat-select [(ngModel)]="gender" placeholder="Gender">
                            <mat-option *ngFor="let g of genders" [value]="g.code">{{ g.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                    </div>
                  </div>

                  <div class="govDocPanel">
                    <div class="govDocHead">Address Details</div>
                    <div class="govDocBody govDemoGraphicBody">
                      <div class="govField">
                        <label>Residence Status <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <mat-select [(ngModel)]="residenceStatus" placeholder="Residence Status">
                            <mat-option *ngFor="let r of residenceStatuses" [value]="r.code">{{ r.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>

                      <div class="govField">
                        <label>Address <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <input matInput placeholder="Address" [(ngModel)]="address" />
                        </mat-form-field>
                      </div>

                      <div class="govField">
                        <label>Region <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <mat-select [(ngModel)]="region" placeholder="Region">
                            <mat-option *ngFor="let r of regions" [value]="r.code">{{ r.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>

                      <div class="govField">
                        <label>Province <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <mat-select [(ngModel)]="parish" placeholder="Province" (selectionChange)="onParishChange()">
                            <mat-option *ngFor="let p of parishes" [value]="p.code">{{ p.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>

                      <div class="govField">
                        <label>City <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <mat-select [(ngModel)]="city" placeholder="City" [disabled]="!parish">
                            <mat-option *ngFor="let c of cities" [value]="c.code">{{ c.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>

                      <div class="govField">
                        <label>Zone <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <mat-select [(ngModel)]="zone" placeholder="Zone">
                            <mat-option *ngFor="let z of zones" [value]="z.code">{{ z.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>

                      <div class="govField">
                        <label>Postal Code <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <mat-select [(ngModel)]="postalCode" placeholder="Postal Code">
                            <mat-option *ngFor="let p of postalCodes" [value]="p.code">{{ p.label }}</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                    </div>
                  </div>

                  <div class="govDocPanel">
                    <div class="govDocHead">Contact Details</div>
                    <div class="govDocBody govDemoGraphicBody">
                      <div class="govField">
                        <label>Phone <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <input matInput placeholder="Phone" [(ngModel)]="phone" />
                        </mat-form-field>
                      </div>

                      <div class="govField">
                        <label>Email <span class="required">*</span></label>
                        <mat-form-field appearance="outline" class="w100 govMatField">
                          <input matInput placeholder="Email" [(ngModel)]="email" />
                        </mat-form-field>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- <div class="govGrid">
                
              </div> -->

              <div class="govBottom">
                <div></div>
                <button type="button" class="govPrimaryBtn" (click)="goToUpload()">Continue</button>
              </div>
            </ng-container>

            <!-- GOVT UPLOAD (eye -> preview) -->
            <ng-container *ngIf="activeStepIndex === 1">
              <ng-container *ngIf="!isUploadPreview">
                <div class="govUploadNote">Allowed: {{ allowedTypes }} • Max: {{ maxSizeText }}</div>

                <div class="govUploadLayout">
                  <div>
                    <div class="govDocPanel" *ngFor="let d of documents">
                      <div class="govDocHead">{{ d.title }} <span *ngIf="d.required" class="required">*</span></div>
                      <div class="govDocBody">
                        <mat-form-field appearance="outline" class="w40 govMatField" style="margin-right: 9px;">
                          <mat-select [(ngModel)]="d.docType" placeholder="Document type">
                            <mat-option *ngFor="let opt of getDocTypeOptions(d.key)" [value]="opt.code">{{ opt.label
                              }}</mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="w40 govMatField" style="margin-right: 9px;">
                          <input matInput placeholder="Reference Id" [(ngModel)]="d.refId" />
                        </mat-form-field>

                        <input #fileInput type="file" class="hiddenFile" accept=".pdf,.png,.jpg,.jpeg"
                          (change)="onFileSelected(d, $event)" />

                        <button type="button" class="govOutlineBtn" (click)="browseFile(d, fileInput)">Browse</button>

                        <div class="govFileRow" *ngIf="d.fileName">
                          <span class="govFileName">{{ d.fileName }}</span>
                          <span class="govFileActions">
                            <button mat-icon-button type="button"
                              (click)="preview(d)"><mat-icon>visibility</mat-icon></button>
                            <button mat-icon-button type="button"
                              (click)="remove(d)"><mat-icon>delete</mat-icon></button>
                          </span>
                        </div>
                      </div>
                    </div>

                  </div>

                  <div class="govPreview">
                    <div class="govPreviewTitle" *ngIf="selectedPreviewTitle">{{ selectedPreviewTitle }}</div>
                    <div class="govPreviewEmpty" *ngIf="previewKind === 'none'">Preview will appear here.</div>

                    <iframe *ngIf="previewKind === 'pdf' && safePdfUrl" class="previewFrame"
                      [src]="safePdfUrl"></iframe>

                    <div *ngIf="previewKind === 'image' && safeImgUrl" class="imgWrap">
                      <img [src]="safeImgUrl" alt="preview" />
                    </div>
                  </div>

                </div>
                <div class="govBottom">
                  <button type="button" class="govOutlineBtn" (click)="goToDemographic()">Back</button>
                  <button type="button" class="govPrimaryBtn" (click)="openUploadPreview()">Continue</button>
                </div>
              </ng-container>

              <!-- GOV PREVIEW (inside upload step) -->
              <ng-container *ngIf="isUploadPreview">

                <div class="govPreviewHeader">
                  <div class="govPreviewTitleTop">Preview <span class="muted">( {{ dataCaptureLanguage }} )</span></div>

                  <button mat-raised-button type="button" class="govOutlineBtn" (click)="goToDemographic()">
                    <mat-icon class="btnIcon">edit</mat-icon> Modify
                  </button>
                </div>

                <div class="govDivider"></div>

                <div class="govPreviewList">
                  <div class="row">
                    <div class="k">Full Name :</div>
                    <div class="v">{{ fullName }}</div>
                  </div>
                  <div class="row">
                    <div class="k">Date Of Birth :</div>
                    <div class="v">{{ dobPreviewText }}</div>
                  </div>
                  <div class="row">
                    <div class="k">Gender :</div>
                    <div class="v">{{ genderLabel }}</div>
                  </div>
                  <div class="row">
                    <div class="k">Residence Status :</div>
                    <div class="v">{{ residenceLabel }}</div>
                  </div>
                  <div class="row">
                    <div class="k">Address :</div>
                    <div class="v">{{ address }}</div>
                  </div>
                  <div class="row">
                    <div class="k">Region :</div>
                    <div class="v">{{ regionLabel }}</div>
                  </div>
                  <div class="row">
                    <div class="k">Province :</div>
                    <div class="v">{{ parishLabel }}</div>
                  </div>
                  <div class="row">
                    <div class="k">City :</div>
                    <div class="v">{{ cityLabel }}</div>
                  </div>
                  <div class="row">
                    <div class="k">Zone :</div>
                    <div class="v">{{ zoneLabel }}</div>
                  </div>
                  <div class="row">
                    <div class="k">Postal Code :</div>
                    <div class="v">{{ postalLabel }}</div>
                  </div>
                  <div class="row">
                    <div class="k">Phone :</div>
                    <div class="v">{{ phone }}</div>
                  </div>
                  <div class="row">
                    <div class="k">Email :</div>
                    <div class="v">{{ email }}</div>
                  </div>
                </div>

                <div class="govDocsHeader">
                  <div class="govDocsTitle">Documents Uploaded</div>
                  <button mat-raised-button type="button" class="govOutlineBtn" (click)="backToUploadEdit()">
                    <mat-icon class="btnIcon">edit</mat-icon> Modify
                  </button>
                </div>

                <div class="govDocPanel">
                  <div class="govDocBody govDocsGrid">
                    <div class="govDocItem" *ngFor="let d of documents">
                      <div class="h">{{ d.title }}</div>
                      <div class="f">{{ d.fileName || '-' }}</div>
                    </div>
                  </div>
                </div>

                <div class="govBottom">
                  <button mat-stroked-button type="button" class="govOutlineBtn"
                    (click)="backToUploadEdit()">Back</button>

                  <div class="govRightBtns">
                    <button mat-raised-button type="button" class="govOutlineBtn">Add Applicant</button>
                    <button mat-stroked-button type="button" class="govPrimaryBtn"
                      (click)="continueFromPreview()">Continue</button>
                  </div>
                </div>

              </ng-container>
            </ng-container>

            <!-- ===================== BOOK APPOINTMENT (GOV) ===================== -->
<ng-container *ngIf="activeStepIndex === 2">
  <ng-container *ngIf="!selectSlots">
    <div class="govBookTopRow">
      <div class="govBookTabs">
        <button type="button" class="govTab" [class.active]="bookTab==='recommended'" (click)="bookTab='recommended'">
          Recommended Centres
        </button>
        <button type="button" class="govTab" [class.active]="bookTab==='nearby'" (click)="bookTab='nearby'">
          Nearby
        </button>
        <span class="govFound">( Found {{ centres.length }} centers. )</span>
      </div>
  
      <button mat-raised-button type="button" class="govOutlineBtn" title="Search">
        <mat-icon class="btnIcon">search</mat-icon> Search
      </button>
    </div>
  
    <div class="govBookLayout">
      <div>
        <div class="govDocPanel" *ngFor="let c of centres" (click)="selectedCentreId=c.id"
             [class.govSelected]="c.id===selectedCentreId">
          <div class="govDocHead">
            <div class="govCentreHead">
              <div class="govRadio" [class.on]="c.id===selectedCentreId"></div>
              <div>
                <div class="govCentreName">{{ c.name }}</div>
                <div class="muted">{{ c.addressLine }}</div>
              </div>
            </div>
          </div>
  
          <div class="govDocBody">
            <div class="govCentreMeta" *ngIf="c.contactName || c.contactPhone">
              <mat-icon>call</mat-icon>
              <span>{{ c.contactName }} , {{ c.contactPhone }}</span>
            </div>
            <div class="govCentreTimes">
              <div>{{ c.timingText }}</div>
              <div>{{ c.lunchText }}</div>
              <div>{{ c.openDaysText }}</div>
            </div>
          </div>
        </div>
      </div>
  
      <div class="govPreview">
        <div class="govPreviewTitle">Map</div>
        <iframe *ngIf="mapEmbedUrl" class="previewFrame" [src]="mapEmbedUrl"></iframe>
      </div>
    </div>
  
    <div class="govBottom">
      <button type="button" class="govOutlineBtn" (click)="bookBack()">Back</button>
  
      <div class="govRightBtns">
        <button type="button" class="govOutlineBtn" (click)="bookLater()">Book Later</button>
        <button type="button" class="govPrimaryBtn" (click)="bookContinue()">Continue</button>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="selectSlots">
    <div class="govDayRow">
      <button type="button" class="govOutlineBtn" (click)="prevDays()">Previous</button>
  
      <div class="govDayCards">
        <div class="govDayCard"
             *ngFor="let day of visibleDays; let i=index"
             [class.active]="i===selectedDayIndex"
             (click)="selectDay(i)">
          <div class="d">{{ fmtDay(day.date) }}</div>
          <div class="w">{{ fmtWeekday(day.date) }}</div>
          <div class="c">{{ day.availableCount }}</div>
          <div class="s">Available Bookings</div>
        </div>
      </div>
  
      <button type="button" class="govOutlineBtn" (click)="nextDays()">Next</button>
    </div>
  
    <div class="govSlotsLayout">
      <div>
        <div class="govSessionTabs">
          <button type="button" class="govTab" [class.active]="selectedSession==='morning'" (click)="setSession('morning')">
            Morning
          </button>
          <button type="button" class="govTab" [class.active]="selectedSession==='afternoon'" (click)="setSession('afternoon')">
            Afternoon
          </button>
        </div>
  
        <div class="govSlotGrid">
          <div class="govSlot"
               *ngFor="let s of filteredSlots"
               [class.selected]="s.id===selectedSlotId"
               (click)="selectSlot(s)">
            <div class="t">{{ s.start }} - {{ s.end }}</div>
            <div class="a">{{ s.available }} slots</div>
          </div>
        </div>
      </div>
  
      <div class="govApplicants">
        <div class="govApplicantsHead">Available Applicants</div>
        <div class="govApplicantsBody">
          <div class="govApplicantRow" *ngFor="let a of applicants">
            <div class="n" [class.selected]="a.id===selectedApplicantId" (click)="selectApplicant(a)">{{ a.name }}</div>
            <button type="button" class="govPlus" (click)="toggleApplicant(a)">{{ a.expanded ? '−' : '+' }}</button>
          </div>
        </div>
      </div>
    </div>
  
    <div class="govBottom">
      <button type="button" class="govOutlineBtn" (click)="backFromSlotSelection()">Back</button>
  
      <div class="govRightBtns">
        <button type="button" class="govOutlineBtn" (click)="bookLater()">Book Later</button>
        <button type="button" class="govPrimaryBtn" (click)="continueAfterSlotSelection()">
          Continue
        </button>
      </div>
    </div>
  </ng-container>

</ng-container>

<!-- ===================== CONFIRMATION (GOV) ===================== -->
<ng-container *ngIf="activeStepIndex === 3">

  <div class="govConfirmSuccess">
    <mat-icon>check_circle</mat-icon>
    <div>
      <b>{{ applicationId }}</b> : Application and Appointment details have been sent to the registered email and phone.
    </div>
  </div>

  <div class="govDocPanel">
    <div class="govDocBody govConfirmGrid">

      <div class="kv">
        <div class="k">Application ID :</div>
        <div class="v">{{ applicationId }}</div>
      </div>

      <div class="kv">
        <div class="k">Appointment Date &amp; Time :</div>
        <div class="v">{{ appointmentDateTimeText }}</div>
      </div>

      <div class="kv">
        <div class="k">Center Contact Number :</div>
        <div class="v">{{ centerContactNumber }}</div>
      </div>

      <div class="qr-dummy-real"></div>

      <div class="govConfirmDivider"></div>

      <div class="kv">
        <div class="k">Name :</div>
        <div class="v">{{ confirmName }}</div>
      </div>

      <div class="kv">
        <div class="k">Center Name :</div>
        <div class="v">{{ confirmCenterName }}</div>
      </div>

      <div class="govConfirmDivider"></div>

      <div class="govConfirmGuides">{{ guidelinesText }}</div>

    </div>
  </div>

  <div class="govBottom">
    <button type="button" class="govOutlineBtn" (click)="sendEmailSms()">Send Email/SMS</button>

    <div class="govRightBtns">
      <button type="button" class="govOutlineBtn" (click)="downloadPdf()">Download PDF</button>
      <button type="button" class="govPrimaryBtn" (click)="printConfirmation()">Print</button>
    </div>
  </div>

</ng-container>


          </div>
        </div>
      </div>
    </ng-container>

    <!-- ===========================================================
         MODERN THEME (photo bg + centered card, keeps ALL fields)
         =========================================================== -->
    <ng-container *ngSwitchCase="'modern'">
      <div class="modernPhotoBg">
        <div class="modernCardShell">

          <div *ngIf="!isUploadPreview" class="modernTop">
            <div class="modernTitle">
              {{ activeStepIndex === 0 ? 'Demographic Details' : 'Upload Documents' }}
              <span class="muted"> ( {{ dataCaptureLanguage }} )</span>
            </div>

            <button *ngIf="activeStepIndex === 0" type="button" class="modernPrimaryBtn"
              (click)="changeDataCaptureLanguages()">
              Change Data Capture Languages
            </button>
          </div>

          <div *ngIf="!isUploadPreview" class="modernLine"></div>

          <div *ngIf="!isUploadPreview" class="modernPills">
            <button type="button" class="pill" [class.active]="activeStepIndex === 0"
              (click)="goToDemographic()">Demographics</button>
            <div class="modernStepLine"></div>
            <button type="button" class="pill" [class.active]="activeStepIndex === 1"
              (click)="goToUpload()">Upload</button>
            <div class="modernStepLine"></div>
            <button type="button" class="pill" [class.active]="activeStepIndex === 2">Book Appointment</button>
            <div class="modernStepLine"></div>
            <button type="button" class="pill" [class.active]="activeStepIndex === 3">Confirmation</button>
          </div>

          <!-- MODERN DEMO (ALL fields) -->
          <ng-container *ngIf="activeStepIndex === 0">
            <div class="modernGrid4">
              <div class="modernField">
                <label>Full Name *</label>
                <mat-form-field appearance="outline" class="w100">
                  <input matInput placeholder="Full Name" [(ngModel)]="fullName" />
                </mat-form-field>
              </div>

              <div class="modernField">
                <label>Date Of Birth *</label>
                <div class="modernDobRow">
                  <mat-form-field appearance="outline" class="w100">
                    <input matInput placeholder="DD/MM/YYYY" [(ngModel)]="dob" />
                  </mat-form-field>
                  <div class="mOr">OR</div>
                  <mat-form-field appearance="outline" class="w100">
                    <input matInput placeholder="Age" [(ngModel)]="age" />
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="w100">
                    <input matInput placeholder="Years" [(ngModel)]="years" />
                  </mat-form-field>
                </div>
              </div>

              <div class="modernField">
                <label>Gender *</label>
                <mat-form-field appearance="outline" class="w100">
                  <mat-select [(ngModel)]="gender" placeholder="Gender">
                    <mat-option *ngFor="let g of genders" [value]="g.code">{{ g.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="modernField">
                <label>Residence Status *</label>
                <mat-form-field appearance="outline" class="w100">
                  <mat-select [(ngModel)]="residenceStatus" placeholder="Residence Status">
                    <mat-option *ngFor="let r of residenceStatuses" [value]="r.code">{{ r.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="modernField">
                <label>Address *</label>
                <mat-form-field appearance="outline" class="w100">
                  <input matInput placeholder="Address" [(ngModel)]="address" />
                </mat-form-field>
              </div>

              <div class="modernField">
                <label>Region *</label>
                <mat-form-field appearance="outline" class="w100">
                  <mat-select [(ngModel)]="region" placeholder="Region">
                    <mat-option *ngFor="let r of regions" [value]="r.code">{{ r.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="modernField">
                <label>Province *</label>
                <mat-form-field appearance="outline" class="w100">
                  <mat-select [(ngModel)]="parish" placeholder="Province" (selectionChange)="onParishChange()">
                    <mat-option *ngFor="let p of parishes" [value]="p.code">{{ p.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="modernField">
                <label>City *</label>
                <mat-form-field appearance="outline" class="w100">
                  <mat-select [(ngModel)]="city" placeholder="City" [disabled]="!parish">
                    <mat-option *ngFor="let c of cities" [value]="c.code">{{ c.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="modernField">
                <label>Zone *</label>
                <mat-form-field appearance="outline" class="w100">
                  <mat-select [(ngModel)]="zone" placeholder="Zone">
                    <mat-option *ngFor="let z of zones" [value]="z.code">{{ z.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="modernField">
                <label>Postal Code *</label>
                <mat-form-field appearance="outline" class="w100">
                  <mat-select [(ngModel)]="postalCode" placeholder="Postal Code">
                    <mat-option *ngFor="let p of postalCodes" [value]="p.code">{{ p.label }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="modernField">
                <label>Phone *</label>
                <mat-form-field appearance="outline" class="w100">
                  <input matInput placeholder="Phone" [(ngModel)]="phone" />
                </mat-form-field>
              </div>

              <div class="modernField">
                <label>Email *</label>
                <mat-form-field appearance="outline" class="w100">
                  <input matInput placeholder="Email" [(ngModel)]="email" />
                </mat-form-field>
              </div>
            </div>

            <div class="modernBottom">
              <div></div>
              <button type="button" class="modernPrimaryBtn" (click)="goToUpload()">Continue</button>
            </div>
          </ng-container>

          <!-- MODERN UPLOAD -->
          <ng-container *ngIf="activeStepIndex === 1">
            <ng-container *ngIf="!isUploadPreview">
              <div class="modernNote">Allowed: {{ allowedTypes }} • Max: {{ maxSizeText }}</div>

              <div class="modernUploadLayout">
                <div>
                  <div class="modernDocTile" *ngFor="let d of documents">
                    <div class="tileHead">
                      <div class="tileTitle">{{ d.title }}</div>
                      <div class="tileReq" *ngIf="d.required">Required</div>
                    </div>

                    <div class="tileBody">
                      <mat-form-field appearance="outline" class="w39" style="margin-right: 9px;">
                        <mat-select [(ngModel)]="d.docType" placeholder="Document type">
                          <mat-option *ngFor="let opt of getDocTypeOptions(d.key)" [value]="opt.code">{{ opt.label
                            }}</mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="w39" style="margin-right: 9px;">
                        <input matInput placeholder="Reference ID" [(ngModel)]="d.refId" />
                      </mat-form-field>
                      <button type="button" class="modernOutlineBtn" (click)="browseFile(d, fileInput)">Browse</button>

                      <input #fileInput type="file" class="hiddenFile" accept=".pdf,.png,.jpg,.jpeg"
                        (change)="onFileSelected(d, $event)" />
                      <div class="modernRow">
                        <div class="fileMini" *ngIf="d.fileName">{{ d.fileName }}</div>
                        <div class="tileActions">
                          <button *ngIf="d.fileName" mat-icon-button type="button" (click)="preview(d)" title="Preview">
                            <mat-icon>visibility</mat-icon>
                          </button>
                          <button *ngIf="d.fileName" mat-icon-button type="button" (click)="remove(d)" title="Remove">
                            <mat-icon>delete</mat-icon>
                          </button>
                        </div>
                      </div>

                    </div>
                  </div>

                </div>

                <div class="modernPreview">
                  <div class="prevTitle" *ngIf="selectedPreviewTitle">{{ selectedPreviewTitle }}</div>
                  <div class="prevEmpty" *ngIf="previewKind === 'none'">Click eye icon to preview.</div>

                  <iframe *ngIf="previewKind === 'pdf' && safePdfUrl" class="previewFrame" [src]="safePdfUrl"></iframe>

                  <div *ngIf="previewKind === 'image' && safeImgUrl" class="imgWrap">
                    <img [src]="safeImgUrl" alt="preview" />
                  </div>
                </div>
              </div>
              <div class="modernBottom">
                <button type="button" class="modernOutlineBtn" (click)="goToDemographic()">Back</button>
                <button type="button" class="modernPrimaryBtn" (click)="openUploadPreview()">Continue</button>
              </div>
            </ng-container>

            <ng-container *ngIf="isUploadPreview">

              <div class="modernPreviewHeader">
                <div class="modernPreviewTitleTop">
                  Preview <span class="muted">( {{ dataCaptureLanguage }} )</span>
                </div>

                <button type="button" class="modernOutlineBtn" (click)="goToDemographic()">
                  <mat-icon>edit</mat-icon> modify
                </button>
              </div>

              <div class="modernLine"></div>

              <div class="modernPreviewList">
                <div class="row">
                  <div class="k">Full Name :</div>
                  <div class="v">{{ fullName }}</div>
                </div>
                <div class="row">
                  <div class="k">Date Of Birth :</div>
                  <div class="v">{{ dobPreviewText }}</div>
                </div>
                <div class="row">
                  <div class="k">Gender :</div>
                  <div class="v">{{ genderLabel }}</div>
                </div>
                <div class="row">
                  <div class="k">Residence Status :</div>
                  <div class="v">{{ residenceLabel }}</div>
                </div>
                <div class="row">
                  <div class="k">Address :</div>
                  <div class="v">{{ address }}</div>
                </div>
                <div class="row">
                  <div class="k">Region :</div>
                  <div class="v">{{ regionLabel }}</div>
                </div>
                <div class="row">
                  <div class="k">Province :</div>
                  <div class="v">{{ parishLabel }}</div>
                </div>
                <div class="row">
                  <div class="k">City :</div>
                  <div class="v">{{ cityLabel }}</div>
                </div>
                <div class="row">
                  <div class="k">Zone :</div>
                  <div class="v">{{ zoneLabel }}</div>
                </div>
                <div class="row">
                  <div class="k">Postal Code :</div>
                  <div class="v">{{ postalLabel }}</div>
                </div>
                <div class="row">
                  <div class="k">Phone :</div>
                  <div class="v">{{ phone }}</div>
                </div>
                <div class="row">
                  <div class="k">Email :</div>
                  <div class="v">{{ email }}</div>
                </div>
              </div>

              <div class="modernDocsHeader">
                <div class="modernDocsTitle">Documents Uploaded</div>
                <button type="button" class="modernOutlineBtn" (click)="backToUploadEdit()">
                  <mat-icon>edit</mat-icon> modify
                </button>
              </div>

              <div class="modernDocsGrid">
                <div class="modernDocBox" *ngFor="let d of documents">
                  <div class="h">{{ d.title }}</div>
                  <div class="f">{{ d.fileName || '-' }}</div>
                </div>
              </div>

              <div class="modernBottom">
                <button type="button" class="modernOutlineBtn" (click)="backToUploadEdit()">Back</button>

                <div class="modernRightBtns">
                  <button type="button" class="modernOutlineBtn">Add Applicant</button>
                  <button type="button" class="modernPrimaryBtn" (click)="continueFromPreview()">Continue</button>
                </div>
              </div>


            </ng-container>
          </ng-container>

          <!-- ===================== BOOK APPOINTMENT (MODERN) ===================== -->
<ng-container *ngIf="activeStepIndex === 2">
  <ng-container *ngIf="!selectSlots">
    <div class="modernBookTopRow">
      <div class="modernBookTabs">
        <button type="button" class="mTab" [class.active]="bookTab==='recommended'" (click)="bookTab='recommended'">
          Recommended Centres
        </button>
        <button type="button" class="mTab" [class.active]="bookTab==='nearby'" (click)="bookTab='nearby'">
          Nearby
        </button>
        <span class="muted">( Found {{ centres.length }} centers. )</span>
      </div>
  
      <button type="button" class="modernOutlineBtn">
        <mat-icon>search</mat-icon>
      </button>
    </div>
  
    <div class="modernBookLayout">
      <div>
        <div class="modernDocTile"
             *ngFor="let c of centres"
             (click)="selectedCentreId=c.id"
             [class.mSelected]="c.id===selectedCentreId">
  
          <div class="tileHead">
            <div class="tileTitle">
              <span class="mRadio" [class.on]="c.id===selectedCentreId"></span>
              {{ c.name }}
            </div>
            <div class="tileReq" *ngIf="c.id===selectedCentreId">Selected</div>
          </div>
  
          <div class="tileBody">
            <div class="muted">{{ c.addressLine }}</div>
  
            <div class="mMeta" *ngIf="c.contactName || c.contactPhone">
              <mat-icon>call</mat-icon>
              <span>{{ c.contactName }} , {{ c.contactPhone }}</span>
            </div>
  
            <div class="mTimes">
              <div>{{ c.timingText }}</div>
              <div>{{ c.lunchText }}</div>
              <div>{{ c.openDaysText }}</div>
            </div>
          </div>
        </div>
      </div>
  
      <div class="modernPreview">
        <div class="prevTitle">Map</div>
        <iframe *ngIf="mapEmbedUrl" class="previewFrame" [src]="mapEmbedUrl"></iframe>
      </div>
    </div>
  
    <div class="modernBottom">
      <button type="button" class="modernOutlineBtn" (click)="bookBack()">Back</button>
  
      <div class="modernRightBtns">
        <button type="button" class="modernOutlineBtn" (click)="bookLater()">Book Later</button>
        <button type="button" class="modernPrimaryBtn" (click)="bookContinue()">Continue</button>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="selectSlots">
    <div class="modernDayRow">
      <button type="button" class="modernOutlineBtn" (click)="prevDays()">Previous</button>
  
      <div class="modernDayCards">
        <div class="modernDayCard"
             *ngFor="let day of visibleDays; let i=index"
             [class.active]="i===selectedDayIndex"
             (click)="selectDay(i)">
          <div class="d">{{ fmtDay(day.date) }}</div>
          <div class="w">{{ fmtWeekday(day.date) }}</div>
          <div class="c">{{ day.availableCount }}</div>
          <div class="s">Available Bookings</div>
        </div>
      </div>
  
      <button type="button" class="modernOutlineBtn" (click)="nextDays()">Next</button>
    </div>
  
    <div class="modernSlotsLayout">
      <div>
        <div class="modernSessionTabs">
          <button type="button" class="mTab" [class.active]="selectedSession==='morning'" (click)="setSession('morning')">
            Morning
          </button>
          <button type="button" class="mTab" [class.active]="selectedSession==='afternoon'" (click)="setSession('afternoon')">
            Afternoon
          </button>
        </div>
  
        <div class="modernSlotGrid">
          <div class="modernSlot"
               *ngFor="let s of filteredSlots"
               [class.selected]="s.id===selectedSlotId"
               (click)="selectSlot(s)">
            <div class="t">{{ s.start }} - {{ s.end }}</div>
            <div class="a">{{ s.available }} slots</div>
          </div>
        </div>
      </div>
  
      <div class="modernApplicants">
        <div class="modernApplicantsHead">Available Applicants</div>
        <div class="modernApplicantsBody">
          <div class="modernApplicantRow" *ngFor="let a of applicants">
            <div class="n" [class.selected]="a.id===selectedApplicantId" (click)="selectApplicant(a)">{{ a.name }}</div>
            <button type="button" class="mPlus" (click)="toggleApplicant(a)">{{ a.expanded ? '−' : '+' }}</button>
          </div>
        </div>
      </div>
    </div>
  
    <div class="modernBottom">
      <button type="button" class="modernOutlineBtn" (click)="backFromSlotSelection()">Back</button>
  
      <div class="modernRightBtns">
        <button type="button" class="modernOutlineBtn" (click)="bookLater()">Book Later</button>
        <button type="button" class="modernPrimaryBtn" (click)="continueAfterSlotSelection()">
          Continue
        </button>
      </div>
    </div>
  </ng-container>

</ng-container>

<!-- ===================== CONFIRMATION (MODERN) ===================== -->
<ng-container *ngIf="activeStepIndex === 3">

  <div class="modernConfirmSuccess">
    <mat-icon>check_circle</mat-icon>
    <div>
      <b>{{ applicationId }}</b> : Application and Appointment details have been sent to the registered email and phone.
    </div>
  </div>

  <div class="modernConfirmCard">

    <div class="modernConfirmGrid">

      <div class="kv">
        <div class="k">Application ID :</div>
        <div class="v">{{ applicationId }}</div>
      </div>

      <div class="kv">
        <div class="k">Appointment Date &amp; Time :</div>
        <div class="v">{{ appointmentDateTimeText }}</div>
      </div>

      <div class="kv">
        <div class="k">Center Contact Number :</div>
        <div class="v">{{ centerContactNumber }}</div>
      </div>

      <div class="qr-dummy-real"></div>     

    </div>

    <div class="modernConfirmLine"></div>

    <div class="modernConfirmGrid2">
      <div class="kv">
        <div class="k">Name :</div>
        <div class="v">{{ confirmName }}</div>
      </div>
      <div class="kv">
        <div class="k">Center Name :</div>
        <div class="v">{{ confirmCenterName }}</div>
      </div>
    </div>

    <div class="modernConfirmLine"></div>

    <div class="modernConfirmGuides">{{ guidelinesText }}</div>
  </div>

  <div class="modernBottom">
    <button type="button" class="modernOutlineBtn" (click)="sendEmailSms()">Send Email/SMS</button>

    <div class="modernRightBtns">
      <button type="button" class="modernOutlineBtn" (click)="downloadPdf()">Download PDF</button>
      <button type="button" class="modernPrimaryBtn" (click)="printConfirmation()">Print</button>
    </div>
  </div>

</ng-container>


        </div>
      </div>
    </ng-container>

  </ng-container>
</div>